

# Aten

Aten即A Tensor library for C++11的缩写，负责声明和定义Tensor运算，旨在取代Torch的TH库。



pytorch使用引用计数来允许张量提供对底层公共存储不同的视图。例如，当对tensor调用view时，一个新的THTensor被分配不同的维度，但是它与原始张量共享相同的c10::StorageImpl。

不幸的是，这意味着我们要在C代码中手工跟踪引用计数。幸运的是，对于我们的大多数库代码实现张量运算，你们只需要记住一条规则：

- **引用计数的黄金法则**：您必须要么FREE内存，要么RETURN一个指针，这个指针是被`new`开头的函数返回的，或者是一个保留指针。如果你返回这个指针，你的函数名必须以`new`开头。

在一个复杂的函数中，可能会调用很多函数名有`new`的函数，我们需要检查并确保对于函数的每一个退出点都有一个free

## TensorBase

该类定义在aten\src\ATen\core\TensorBase.h

```c++
class TORCH_API TensorBase {
 protected:
  // Create a Tensor with a +0 reference count. Special care must be
  // taken to avoid decrementing this reference count at destruction
  // time. Intended to support MaybeOwnedTraits<Tensor>.
  explicit TensorBase(unsafe_borrow_t, const TensorBase& rhs)
      : impl_(c10::intrusive_ptr<at::TensorImpl, UndefinedTensorImpl>::reclaim(rhs.impl_.get())) {}
  friend MaybeOwnedTraits<TensorBase>;

 public:
    TensorBase() = default;
    // This constructor should not be used by end users and is an implementation
    // detail invoked by autogenerated code.
    explicit TensorBase(
        c10::intrusive_ptr<TensorImpl, UndefinedTensorImpl> tensor_impl)
        : impl_(std::move(tensor_impl)) {
            if (impl_.get() == nullptr) {
                throw std::runtime_error("TensorImpl with nullptr is not supported");
            }
        }
    TensorBase(const TensorBase&) = default;
    TensorBase(TensorBase&&) noexcept = default;
  
    TensorBase contiguous(MemoryFormat memory_format=MemoryFormat::Contiguous) const {
        if (is_contiguous(memory_format)) {
            return *this;
        } else {
            return __dispatch_contiguous(memory_format);
        }
    }
    
	/// Returns if a `Tensor` has CUDA backend.
    bool is_cuda() const {
        // NB: this is not a native function to avoid dispatching overhead.
        return impl_->is_cuda();
    }
    
    void reset() {
        impl_.reset();
    }
    
    int64_t dim() const {
        return impl_->dim();
    }
    
 protected:
	// 数据成员
    c10::intrusive_ptr<TensorImpl, UndefinedTensorImpl> impl_;
};
    
```

## Tensor

[Class Tensor — PyTorch main documentation](https://pytorch.org/cppdocs/api/classat_1_1_tensor.html)

pytorch中的tensor定义在`build/aten/src/ATen/core/TensorBody.h`，对`TensorBase`做了一层封装

```c++
class TORCH_API Tensor: public TensorBase {
 protected:
  // Create a Tensor with a +0 reference count. Special care must be
  // taken to avoid decrementing this reference count at destruction
  // time. Intended to support MaybeOwnedTraits<Tensor>.
  explicit Tensor(unsafe_borrow_t, const TensorBase& rhs): TensorBase(unsafe_borrow_t{}, rhs) {}
  friend MaybeOwnedTraits<Tensor>;
  friend OptionalTensorRef;
  friend TensorRef;

 public:
  Tensor() = default;
  // This constructor should not be used by end users and is an implementation
  // detail invoked by autogenerated code.
  explicit Tensor(
      c10::intrusive_ptr<TensorImpl, UndefinedTensorImpl> tensor_impl)
      : TensorBase(std::move(tensor_impl)) {}
  Tensor(const Tensor &tensor) = default;
  Tensor(Tensor &&tensor) = default;

  // Implicitly move-constructible from TensorBase, but must be explicit to increase refcount
  explicit Tensor(const TensorBase &base): TensorBase(base) {}
  /*implicit*/ Tensor(TensorBase &&base): TensorBase(std::move(base)) {}

  // Creates a new wrapper from TensorImpl. Intentionally a free method because
  // it should be used with care. Checks necessary invariants
  static Tensor wrap_tensor_impl(
      c10::intrusive_ptr<TensorImpl, UndefinedTensorImpl> tensor_impl) {
    return TensorBase::wrap_tensor_impl(std::move(tensor_impl));
  }

  Tensor contiguous(MemoryFormat memory_format=MemoryFormat::Contiguous) const {
    return TensorBase::contiguous(memory_format);
  }
```







In place operations are also provided, and always suffixed by _ to indicate they will modify the Tensor.

# C10

CTen是Caffe2 Tensor的缩写。

CTen是ATen的基础，是pytorch的核心库。它包含PyTorch使用的基本构建块，包括TensorImpl(张量元数据结构)和dispatcher（负责将运算符调用路由到正确的内核实现）。



## c10和aten的区别

atan是张量库，所有张量操作都定义在其中。c10是核心库，负责将运算符调用路由到正确的kernel实现上。

# torch

torch命名空间下定义的 Tensor 相比于ATen 增加自动求导功能

torch下的tensor

```python
class Tensor(torch._C.TensorBase):
```

















